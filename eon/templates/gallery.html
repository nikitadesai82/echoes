{% extends "webbase.html" %} {% load static %} {% block overlay_content %}
<script>
  document.documentElement.classList.remove("loading");
</script>
<div class="gallery-mainbox">
  <div class="gallery-box4">
    <div class="gallery-box4_1">
      <div class="Scientific_name">
        {% if bird %} SCIENTIFIC NAME:{{ bird.Bird_Scientific_Name }} {% elif flora %} BOTANICAL NAME: {{ flora.Flora_Botanical_Name }} {% endif %}
      </div>
      <div class="gallery-name">
        <div class="gallery-name">
          {% if bird %} {{ bird.Bird_Name|upper }} {% elif flora %} {{ flora.Flora_Name|upper }} {% endif %}
        </div>
      </div>
      <div class="gallery-alias">
        {% if bird %} AKA: {{ bird.Bird_AKA }} {% elif flora.Flora_AKA %}AKA: {{ flora.Flora_AKA }} {% endif %}
      </div>
    </div>
    {% if flora %}
    <div class="shot-location">
      Shot on location at<br />
      Hiranandani Estate, Thane
    </div>
    {% endif %}

    <div
      class="gallery-videotab {% if not bird or not bird.Bird_Video %}hidden{% endif %}"
      id="videoTab"
    >
      WATCH VIDEO
    </div>
    <div
      class="gallery-picturetab {% if flora %}hidden{% endif %}"
      id="photoTab"
    >
      SEE PHOTO
    </div>
  </div>
  <div class="gallery-box2">
    <!-- PHOTO CONTENT -->
    <div id="photoBox" class="gallery-media-section">
      <!-- BIRD IMAGES -->
      {% if bird %} {% if bird.Bird_Image1 %}
      <img
        class="gallery-slide"
        src="{{ bird.Bird_Image1.url }}"
        alt="{{ bird.Bird_Name }}"
      />
      {% endif %} {% if bird.Bird_Image2 %}
      <img
        class="gallery-slide"
        src="{{ bird.Bird_Image2.url }}"
        alt="{{ bird.Bird_Name }}"
      />
      {% endif %} {% endif %}

      <!-- FLORA IMAGES -->
      {% if flora %} {% if flora.Flora_Image_1 %}
      <img
        class="gallery-slide"
        src="{{ flora.Flora_Image_1.url }}"
        alt="{{ flora.Flora_Name }}"
      />
      {% endif %} {% if flora.Flora_Image_2 %}
      <img
        class="gallery-slide"
        src="{{ flora.Flora_Image_2.url }}"
        alt="{{ flora.Flora_Name }}"
      />
      {% endif %} {% if flora.Flora_Image_3 %}
      <img
        class="gallery-slide"
        src="{{ flora.Flora_Image_3.url }}"
        alt="{{ flora.Flora_Name }}"
      />
      {% endif %} {% endif %}

      <!-- DOT PAGINATOR -->
    </div>

    <!-- VIDEO CONTENT -->
<div id="videoBox" class="gallery-media-section" style="display: none">

  {% if bird and bird.Bird_Video %}
  <video class="gallery-slide" controls playsinline preload="metadata">
    <source src="{{ bird.Bird_Video.url }}" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  {% endif %}

  {% if flora and flora.Flora_Media_1 %}
  <video class="gallery-slide" controls autoplay muted loop playsinline>
    <source src="{{ flora.Flora_Media_1.url }}" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  {% endif %}

</div>
  </div>
  <div class="gallery-extra">
    <img src="{% static 'img/gallery.png' %}" />
  </div>
  <div class="prev-next">
    <img
      src="{% static 'img/prev.png' %}"
      class="bg-nav-btn bg-prev"
      id="bg-prev"
      alt="Previous"
      tabindex="0"
    />

    <img
      src="{% static 'img/next.png' %}"
      class="bg-nav-btn bg-next"
      id="bg-next"
      alt="Next"
      role="button"
      tabindex="0"
    />
  </div>
  <!-- dots -->
  <script>
    (function () {
      let galleryVideoPlaying = false;

      function isMainGalleryVideo(video) {
        return video && video.id === "galleryVideo";
      }

      function enforceMute() {
        if (!galleryVideoPlaying) return;

        document.querySelectorAll("audio, video").forEach((m) => {
          if (isMainGalleryVideo(m)) return;

          m.muted = true;
          m.volume = 0;

          // stop GSAP from resurrecting audio
          if (window.gsap) gsap.killTweensOf(m);
        });
      }

      // üîí Detect main gallery video play (CAPTURE PHASE)
      document.addEventListener(
        "play",
        (e) => {
          if (e.target.tagName !== "VIDEO") return;
          if (!isMainGalleryVideo(e.target)) return;

          galleryVideoPlaying = true;

          enforceMute();
        },
        true,
      );

      // üîì Release when gallery video stops
      function releaseMute() {
        galleryVideoPlaying = false;

        document.querySelectorAll("audio, video").forEach((m) => {
          if (isMainGalleryVideo(m)) return;

          m.muted = false;
        });
      }

      document.addEventListener(
        "pause",
        (e) => {
          if (isMainGalleryVideo(e.target)) releaseMute();
        },
        true,
      );

      document.addEventListener(
        "ended",
        (e) => {
          if (isMainGalleryVideo(e.target)) releaseMute();
        },
        true,
      );

      // üîÅ HARD ENFORCEMENT LOOP (this is the killer feature)
      setInterval(enforceMute, 200);
    })();
  </script>
  <div id="dotContainer" class="gallery-dots2"></div>

  <div class="gallery-box3">
    <div class="close-icon" id="closeBtn">
      <img src="{% static 'img/Close.png' %}" alt="close" />
    </div>

    <div class="gallery-ani">
      <video autoplay muted loop playsinline>
        <source src="{% static 'video/gallery.webm' %}" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
  </div>
</div>

<script>
  let isAnimating = false;

  function showSlide(index, direction = "next") {
    const slides = getActiveSlides();
    if (!slides.length || isAnimating) return;

    if (!slides[currentIndex]) currentIndex = 0;

    const currentSlide = slides[currentIndex];
    const nextSlide = slides[index];

    if (currentSlide === nextSlide) return;

    isAnimating = true;

    // Pause outgoing video (safe even if none)
    const vid = currentSlide.querySelector("video");
    if (vid) vid.pause();

    const fromX = direction === "next" ? "100%" : "-100%";
    const toX = direction === "next" ? "-100%" : "100%";

    gsap.set(nextSlide, {
      display: "block",
      x: fromX,
    });

    gsap
      .timeline({
        onComplete: () => {
          slides.forEach((s, i) => {
            if (i !== index) gsap.set(s, { display: "none", x: 0 });
          });
          currentIndex = index;
          isAnimating = false;
        },
      })
      .to(currentSlide, {
        x: toX,
        duration: 0.6,
        ease: "power2.inOut",
      })
      .to(
        nextSlide,
        {
          x: "0%",
          duration: 0.6,
          ease: "power2.inOut",
        },
        "<",
      );

    // ‚úÖ FIXED: update individual dots
    document.querySelectorAll(".gallery-dot").forEach((dot, i) => {
      dot.classList.toggle("active", i === index);
    });
  }
</script>

<script>
  const photoTab = document.getElementById("photoTab");
  const videoTab = document.getElementById("videoTab");

  const photoBox = document.getElementById("photoBox");
  const videoBox = document.getElementById("videoBox");

  const nextBtn = document.getElementById("bg-next");
  const prevBtn = document.getElementById("bg-prev");
  const dotContainer = document.querySelector(".gallery-dots2");

  let currentIndex = 0;

  /* =======================
   GET ACTIVE SLIDES
   ======================= */
  function getActiveSlides() {
    return getComputedStyle(photoBox).display !== "none"
      ? photoBox.querySelectorAll(".gallery-slide")
      : videoBox.querySelectorAll(".gallery-slide");
  }
  function updateNavigationVisibility() {
    const isPhoto = getComputedStyle(photoBox).display !== "none";

    // üö´ Video ‚Üí never show nav
    if (!isPhoto) {
      nextBtn.style.display = "none";
      prevBtn.style.display = "none";
      dotContainer.style.display = "none";
      return;
    }

    const slides = photoBox.querySelectorAll(".gallery-slide");
    const showNav = slides.length > 1;

    nextBtn.style.display = showNav ? "block" : "none";
    prevBtn.style.display = showNav ? "block" : "none";
    dotContainer.style.display = showNav ? "flex" : "none";
  }

  /* =======================
   CREATE DOTS (PHOTO ONLY)
   ======================= */
  function createDots() {
    if (!dotContainer) return;

    const slides = photoBox.querySelectorAll(".gallery-slide");

    // üö´ Hide dots if only one or zero images
    if (slides.length <= 1) {
      dotContainer.innerHTML = "";
      dotContainer.style.display = "none";
      return;
    }

    dotContainer.innerHTML = "";
    dotContainer.style.display = "flex";

    slides.forEach((_, index) => {
      const dot = document.createElement("div");
      dot.classList.add("gallery-dot");

      if (index === currentIndex) dot.classList.add("active");

      dot.addEventListener("click", () => {
        const direction = index > currentIndex ? "next" : "prev";
        showSlide(index, direction);
      });

      dotContainer.appendChild(dot);
    });
  }

  /* =======================
   RESET SLIDES
   ======================= */
  function resetSlides() {
    const isPhoto = getComputedStyle(photoBox).display !== "none";

    if (!isPhoto) return; // üö® DO NOTHING for video

    const slides = photoBox.querySelectorAll(".gallery-slide");

    slides.forEach((slide, i) => {
      gsap.set(slide, {
        display: i === 0 ? "block" : "none",
        x: 0,
      });
    });

    currentIndex = 0;
    createDots();
    updateNavigationVisibility(); // ‚úÖ ADD
  }

  /* =======================
   TAB HANDLERS
   ======================= */
function showPhoto() {
  // Stop video when switching back
  const video = videoBox.querySelector("video");
  if (video) {
    video.pause();
    video.currentTime = 0;
  }

  videoBox.style.display = "none";
  photoBox.style.display = "block";

  photoTab.classList.add("active");
  videoTab.classList.remove("active");

  resetSlides();
}


function showVideo() {
  updateNavigationVisibility();

  photoBox.style.display = "none";
  videoBox.style.display = "block";

  videoTab.classList.add("active");
  photoTab.classList.remove("active");

  // Optional autoplay for bird video
  const video = videoBox.querySelector("video");
  if (video) {
    video.currentTime = 0;
    video.play().catch(() => {});
  }
}


  /* =======================
   NEXT / PREV BUTTONS
   ======================= */
  function nextSlide() {
    const slides = getActiveSlides();
    if (!slides.length) return;

    const nextIndex = (currentIndex + 1) % slides.length;
    showSlide(nextIndex, "next");
  }

  function prevSlide() {
    const slides = getActiveSlides();
    if (!slides.length) return;

    const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
    showSlide(prevIndex, "prev");
  }

  if (nextBtn && prevBtn) {
    nextBtn.addEventListener("click", nextSlide);
    prevBtn.addEventListener("click", prevSlide);

    // Keyboard accessibility
    nextBtn.addEventListener(
      "keydown",
      (e) => e.key === "Enter" && nextSlide(),
    );
    prevBtn.addEventListener(
      "keydown",
      (e) => e.key === "Enter" && prevSlide(),
    );
  }

  /* =======================
   TAB EVENTS
   ======================= */
  if (photoTab && videoTab) {
    photoTab.addEventListener("click", showPhoto);
    videoTab.addEventListener("click", showVideo);
  }

  /* =======================
   AUTO TAB FROM URL
   ======================= */
  const urlParams = new URLSearchParams(window.location.search);
  const type = urlParams.get("type");

  type === "video" ? showVideo() : showPhoto();
</script>
<script>
  document.getElementById("closeBtn").addEventListener("click", function () {
    // Go back to previous page AND restore scroll
    if (window.history.length > 1) {
      history.back();
    } else {
      window.location.href = "/"; // fallback if user opened gallery directly
    }
  });
</script>

<script>
  let touchStartX = 0;
  let touchEndX = 0;
  const SWIPE_THRESHOLD = 50; // px

  function handleSwipe() {
    // Only allow swipe on PHOTO mode
    if (getComputedStyle(photoBox).display === "none") return;

    const deltaX = touchEndX - touchStartX;

    if (Math.abs(deltaX) < SWIPE_THRESHOLD) return;

    if (deltaX < 0) {
      nextSlide(); // üëâ swipe left
    } else {
      prevSlide(); // üëà swipe right
    }
  }

  // Attach swipe listeners to photoBox
  photoBox.addEventListener(
    "touchstart",
    (e) => {
      touchStartX = e.changedTouches[0].screenX;
    },
    { passive: true },
  );

  photoBox.addEventListener(
    "touchend",
    (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    },
    { passive: true },
  );
</script>

{% endblock %}
