{% extends "webbase.html" %} {% load static %} {% block overlay_content %}
<script>
	document.documentElement.classList.remove('loading');
</script>

<div class="Bird_list_firstbox">
	<div class="Bird_list_intro">
		<span class="Bird_list_title_inner">
			Who’s Chirping? Spot, Listen & Discover
		</span>
	</div>
	<div class="Bird_list_title">
		<span class="Bird_list_title_inner">Birds of Hiranandani Estate</span>
	</div>
	<div class="Bird_list_subtitle">
		From tiny sunbirds to majestic herons, learn about the feathered fellows
		living at Hiranandani Estate, Thane. Sort and filter the list to discover
		who are the day singers, night flyers and visiting migrants. Then, just tap
		on a bird to know more about its every chirp and flutter.
	</div>
</div>
<div class="Bird_list_secondbox">
	<div class="filter-ui">
		<div class="filter-dropdowns">
			<button class="filter-toggle" id="activeTimeToggle">
				Active Time
				<span class="arrow"></span>
			</button>

			<button class="filter-toggle" id="dietToggle">
				Diet
				<span class="arrow"></span>
			</button>

			<button class="filter-toggle" id="migrationToggle">
				Migration
				<span class="arrow"></span>
			</button>
		</div>

		<div class="filter-options" id="activeTimeOptions" style="display: none">
			<label>
				<input type="radio" name="activeTime" value="Crepuscular" />
				Crepuscular
			</label>
			<label>
				<input type="radio" name="activeTime" value="Diurnal" />
				Diurnal
			</label>
			<label>
				<input type="radio" name="activeTime" value="Nocturnal" />
				Nocturnal
			</label>
		</div>

		<div class="filter-options" id="dietOptions" style="display: none">
			<label>
				<input type="radio" name="diet" value="Carnivore" />
				Carnivorous
			</label>
			<label>
				<input type="radio" name="diet" value="Granivore" />
				Granivorous
			</label>
			<label>
				<input type="radio" name="diet" value="Herbivore" />
				Herbivorous
			</label>
			<label>
				<input type="radio" name="diet" value="Insectivore" />
				Insectivorous
			</label>
			<label>
				<input type="radio" name="diet" value="Nectarivore" />
				Nectarivorous
			</label>
			<label>
				<input type="radio" name="diet" value="Omnivore" />
				Omnivore
			</label>
			<label>
				<input type="radio" name="diet" value="Piscivore" />
				Piscivore
			</label>
			<label>
				<input type="radio" name="diet" value="Scavenger" />
				Scavenger
			</label>
		</div>

		<div class="filter-options" id="migrationOptions" style="display: none">
			<label>
				<input type="radio" name="migration" value="Migratory" />
				Migratory
			</label>
			<label>
				<input type="radio" name="migration" value="Non-migratory" />
				Non-migratory
			</label>
		</div>

		<div id="selectedFilters"></div>
	</div>
	<div class="filter-desc">
	<div class="filter-desc-head">BIRD ACTIVITY TIME</div>
Diurnal – Active mainly during the daytime<br>
Nocturnal – Active mainly at night<br>
Crepuscular – Active mostly at dawn and dusk<br>
</div>
	<div class="Arch-box">
	<img src="{% static 'img/birdlistgirl.webp' %}">
	</div>
	<div class="Sort-box sort-dropdown" onclick="toggleDropdown()">
		<div class="sort-header">
			<div class="sort-label">
				<span id="selected-sort" class="sort-type"></span>
			</div>
			<button class="arrow" aria-label="Down"></button>
		</div>

		<div id="dropdown-menu" class="dropdown-menu">
			<div
				class="drop-content"
				data-sort="az"
				onclick="selectSort('A to Z', 'az')"
			>
				Sort by: Alphabetical: A to Z
			</div>

			<div
				class="drop-content"
				data-sort="za"
				onclick="selectSort('Z to A', 'za')"
			>
				Sort by: Alphabetical: Z to A
			</div>

			<div
				class="drop-content"
				data-sort="small"
				onclick="selectSort('Small to Large', 'small')"
			>
				Sort by: Size: Small to Large
			</div>

			<div
				class="drop-content"
				data-sort="large"
				onclick="selectSort('Large to Small', 'large')"
			>
				Sort by: Size: Large to Small
			</div>
		</div>
	</div>
	<div class="filter-desc-right">
	<div class="filter-desc-head">BIRD DIET TYPES</div>
Insectivore – Eat insects<br>
Herbivore – Eat plants, leaves, or fruits<br>
Carnivore: Eat other animals<br>
Scavenger: Feed on dead animals<br>
Piscivore: Eat fish<br>
Nectivore: Feed on flower nectar<br>
Grainivore: Eat grains and seeds<br>
Omnivore: Eat both plants and animals
</div>
</div>
<div class="bird-gallery">
  {% if birds %}
    {% for bird in birds %}
      <a href="{% url 'bird_detail' bird.slug %}" class="bird-item">
        {% if bird.Bird_Button_Media %}
          <video
            class="info-video"
            loop
            muted
            playsinline
            preload="none"
            width="460"
            height="460"
            data-src="{{ bird.Bird_Button_Media.url }}"
            poster="{{ bird.Bird_Button_Thumb }}"
            aria-label="{{ bird.Bird_Name }} preview"
          ></video>
        {% endif %}
        <div class="bird-name">{{ bird.Bird_Name }}</div>
      </a>
    {% endfor %}
  {% else %}
    <div class="no-results">
      “Empty nest! Try adjusting the filters.”
    </div>
  {% endif %}
</div>


<script>
	const selected = { activeTime: null, diet: null, migration: null };

	document.getElementById('activeTimeToggle').onclick = () =>
		toggleFilter('activeTimeOptions', 'activeTimeToggle');

	document.getElementById('dietToggle').onclick = () =>
		toggleFilter('dietOptions', 'dietToggle');

	document.getElementById('migrationToggle').onclick = () =>
		toggleFilter('migrationOptions', 'migrationToggle');

	function toggleFilter(targetId, buttonId) {
		const box = document.getElementById(targetId);
		const btn = document.getElementById(buttonId);
		const isOpen = box.style.display === 'grid';

		hideAllOptions();

		if (!isOpen) {
			box.style.display = 'grid';
			btn.classList.add('open');
		}
	}

	function reopenLastSelectedFilter() {
		const orderedFilters = ['activeTime', 'diet', 'migration'];
		let lastSelected = null;

		// Check URL in original order → last one found wins
		const url = new URL(window.location.href);
		orderedFilters.forEach((f) => {
			if (url.searchParams.get(f)) lastSelected = f;
		});

		if (lastSelected) {
			hideAllOptions();
			const box = document.getElementById(lastSelected + 'Options');
			const btn = document.getElementById(lastSelected + 'Toggle');

			box.style.display = 'grid';
			btn.classList.add('open');
		}
	}

	function hideAllOptions() {
		document
			.querySelectorAll('.filter-options')
			.forEach((opt) => (opt.style.display = 'none'));
		document
			.querySelectorAll('.filter-toggle')
			.forEach((btn) => btn.classList.remove('open'));
	}

	function updateSelectedFilters() {
		const container = document.getElementById('selectedFilters');
		container.innerHTML = '';

		Object.keys(selected).forEach((key) => {
			if (selected[key]) {
				const chip = document.createElement('div');
				chip.className = 'selected-chip';
				chip.textContent = selected[key];

				const x = document.createElement('span');
				x.className = 'chip-close';
				x.textContent = '×';

				x.onclick = function () {
					selected[key] = null;
					const checked = document.querySelector(
						`input[name="${key}"]:checked`,
					);
					if (checked) checked.checked = false;

					const url = new URL(window.location.href);
					url.searchParams.delete(key);
					window.location.href = url.toString();
				};

				chip.appendChild(x);
				container.appendChild(chip);
			}
		});
	}

	['activeTime', 'diet', 'migration'].forEach((filter) => {
		document.querySelectorAll(`input[name="${filter}"]`).forEach((radio) => {
			radio.onchange = function () {
				selected[filter] = radio.value;
				updateSelectedFilters();

				const url = new URL(window.location.href);
				url.searchParams.set(filter, radio.value);

				window.location.href = url.toString();
			};
		});
	});

	document.addEventListener('DOMContentLoaded', () => {
		const url = new URL(window.location.href);

		['activeTime', 'diet', 'migration'].forEach((filter) => {
			const value = url.searchParams.get(filter);
			if (value) {
				const radio = document.querySelector(
					`input[name="${filter}"][value="${value}"]`,
				);
				if (radio) radio.checked = true;
				selected[filter] = value;
			}
		});

		updateSelectedFilters();
		reopenLastSelectedFilter(); // ⭐ only the latest filter stays open
	});

	document.addEventListener('click', function (e) {
		if (
			!e.target.closest('.filter-toggle') &&
			!e.target.closest('.filter-options')
		) {
			hideAllOptions();
		}
	});

	function toggleDropdown() {
		document.querySelector('.Sort-box').classList.toggle('open');
	}

	/* ---------------- APPLY SORT ---------------- */
	function selectSort(labelType, sortCode) {
		const url = new URL(window.location.href);
		url.searchParams.set('sort', sortCode);
		window.location.href = url.toString();
	}

	/* ---------------- RESTORE + HIDE ACTIVE ---------------- */
	document.addEventListener('DOMContentLoaded', () => {
		const url = new URL(window.location.href);
		let sort = url.searchParams.get('sort') || 'az';

		// Force default az in URL (without reload)
		if (!url.searchParams.get('sort')) {
			url.searchParams.set('sort', 'az');
			window.history.replaceState({}, '', url);
		}

		const labelMap = {
			az: 'Sort by: Alphabetical: A to Z',
			za: 'Sort by: Alphabetical: Z to A',
			small: 'Sort by: Size: Small to Large',
			large: 'Sort by: Size: Large to Small',
		};

		// Update heading label
		document.getElementById('selected-sort').innerText = labelMap[sort];

		// Hide currently active option
		document.querySelectorAll('.drop-content').forEach((opt) => {
			opt.style.display = opt.dataset.sort === sort ? 'none' : 'flex';
		});
	});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const videos = document.querySelectorAll(".info-video");

  if (!('IntersectionObserver' in window)) {
    videos.forEach(video => {
      loadAndPlay(video);
    });
    return;
  }

  const options = {
    root: null,
    rootMargin: '200px 0px',
    threshold: 0.25          
  };

  const observer = new IntersectionObserver(handleIntersections, options);

  videos.forEach(v => {
    v.removeAttribute('autoplay');
    observer.observe(v);
  });

  function handleIntersections(entries) {
    entries.forEach(entry => {
      const video = entry.target;
      if (entry.isIntersecting) {
        if (!video.dataset.loaded) {
          const src = video.dataset.src;
          if (src) {
            const source = document.createElement('source');
            source.src = src;
            video.appendChild(source);
            video.dataset.loaded = "true";
            video.load();
          }
        }

        video.play().catch(() => {  });
      } else {
        if (!video.paused) {
          video.pause();
        }

      }
    });
  }

  function unloadVideo(video) {
    if (video.dataset.loaded) {
      video.pause();
      const sources = video.querySelectorAll('source');
      sources.forEach(s => s.remove());
      try {
        video.removeAttribute('src');
        video.load();
      } catch (e) {}
      delete video.dataset.loaded;
    }
  }
});
</script>

<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>

<script src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js"></script>

<script>
	/*HIDE PAGE UNTIL GSAP IS READY*/
	document.documentElement.classList.add('loading');

	document.addEventListener('DOMContentLoaded', () => {
		gsap.registerPlugin(ScrollTrigger);

		requestAnimationFrame(() => {
			gsap.set('body', { visibility: 'visible' });
			document.documentElement.classList.remove('loading');

			const tl = gsap.timeline({ defaults: { ease: 'power3.out' } });

			tl.fromTo(
				'.Bird_list_title_inner',
				{ yPercent: 100, opacity: 0 },
				{ yPercent: 0, opacity: 1, duration: 0.6 },
			)

				.fromTo(
					'.Bird_list_intro',
					{ opacity: 0 },
					{ opacity: 1, duration: 0.6 },
					0.5,
				)

				.fromTo(
					'.Bird_list_subtitle',
					{ opacity: 0 },
					{ opacity: 1, duration: 0.6 },
					0.5,
				)

				.fromTo(
					'.filter-toggle,.filter-options,.selected-chip',
					{ opacity: 0 },
					{ opacity: 1, duration: 0.5, stagger: 0.05 },
					0.5,
				)

				.fromTo(
					'.Arch-box',
					{ opacity: 0, scale: 0.95 },
					{ opacity: 1, scale: 1, duration: 0.6 },
					0.5,
				)
				.fromTo(
          ".filter-desc",
          { opacity: 0},
          { opacity: 1,duration: 0.5 },
          '-=0.55',
        )
				.fromTo(
          ".filter-desc-right",
          { opacity: 0},
          { opacity: 1,duration: 0.5 },
          '-=0.55',
        )

			/*BIRD GRID — ROW BASED ANIMATION*/
			const items = [...document.querySelectorAll('.bird-item')];
			let rows = [];
			let currentRowTop = null;

			items.forEach((item) => {
				const top = item.getBoundingClientRect().top;

				if (currentRowTop === null || Math.abs(top - currentRowTop) < 8) {
					if (!rows.length) rows.push([]);
					rows[rows.length - 1].push(item);
					currentRowTop = top;
				} else {
					rows.push([item]);
					currentRowTop = top;
				}
			});

			// FIRST ROW — PLAY IMMEDIATELY
			if (rows.length) {
				const firstRowTl = gsap.timeline({ delay: 0.5 });

				firstRowTl.fromTo(
					rows[0],
					{
						y: 40,
						scale: 0.7,
						opacity: 0,
					},
					{
						y: 0,
						scale: 1,
						opacity: 1,
						duration: 0.6,
						ease: 'back.out(2.5)',
						stagger: 0.12,
					},
				);
			}

			// OTHER ROWS — SCROLL IN + REVERSE ON SCROLL UP
			rows.slice(1).forEach((row) => {
				gsap.fromTo(
					row,
					{ y: 40, scale: 0.7, opacity: 0 },
					{
						y: 0,
						scale: 1,
						opacity: 1,
						duration: 0.6,
						ease: 'back.out(1.7)',
						stagger: 0.12,
						scrollTrigger: {
							trigger: row[0],
							start: 'top 90%',
							toggleActions: 'play none none none',
						},
					},
				);
			});

			/*SORT BOX — WIDTH SCALE FROM CENTER*/
			gsap.utils.toArray('.Sort-box').forEach((btn) => {
				const tl = gsap.timeline({
					scrollTrigger: {
						trigger: btn,
						start: 'top 80%',
						toggleActions: 'play none none none',
					},
				});

				tl.fromTo(
					btn,
					{ '--reveal': 0 },
					{
						'--reveal': 1.15,
						duration: 0.45,
						ease: 'power2.out',
					},
				).to(
					btn,
					{
						'--reveal': 1,
						duration: 0.25,
						ease: 'back.out(1.4)',
					},
					'-=0.2',
				);
			});
		});
	});
</script>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const bg = document.querySelector('.Bird-image');
		if (!bg) return;

		gsap.fromTo(
			bg,
			{ yPercent: 5 },
			{
				yPercent: -20,
				ease: 'none',
				scrollTrigger: {
					start: 0,
					end: () => ScrollTrigger.maxScroll(window),
					scrub: true,
					invalidateOnRefresh: true,
				},
			},
		);
	});
</script>

{% endblock %}
