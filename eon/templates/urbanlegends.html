{% extends "webbase.html" %} {% load static %} {% block overlay_content %} {% load static %}

<div class="urbanlegendsbox1">
	<div class="urbanlegendsbox1_1">GREEN BEGINNINGS</div>
	<div class="urbanlegendsbox1_2">
		<span class="inner2">Building with Nature</span>
	</div>
	<div class="urbanlegendsbox1_3">
		A behind-the-scenes look at how the Hiranandani Estate Thaneâ€™s lush
		landscapes came to life! Hear from builders, horticulturists and naturalists
		about this thriving urban ecosystem. Choose a story to explore then hit play
		to listen as it unfolds.
	</div>
</div>

<div class="urbanlegendsbird-ani">
	<video autoplay muted loop playsinline>
		<source
			src="{% static 'video/urbanlegends-bird.mp4' %}"
			type="video/mp4"
		/>
	</video>
</div>

<div class="urbanlegendsbox2">
	<!-- âœ… STORY LIST -->
	<div class="selection-box">
		{% for story in stories %}
		<div
			class="btn-fill-circle2 story"
			data-title="{{ story.Story_Title }}"
			data-text="{{ story.Story_text }}"
			data-image="{% if story.Story_Image %}{{ story.Story_Image.url }}{% endif %}"
			data-audio="{% if story.Story_Audio %}{{ story.Story_Audio.url }}{% endif %}"
		>
			{{ story.Story_Title }}
		</div>

		{% endfor %}
	</div>

	<!-- âœ… IMAGE AREA -->
	<div class="urbanlegend-img">
		<img id="storyImage" src="" alt="" />
	</div>

	<!-- âœ… TEXT + AUDIO -->
	<div class="urbanlegend-text">
		<div class="story_name" id="storyTitle">
			<span class="story_name-inner"></span>
		</div>
		<div class="story_text" id="storyText"></div>

		<div class="story-sound" id="storyAudioBox" style="display: none">
			<div class="play-button">
				<img
					id="playPauseBtn"
					src="{% static 'img/Play.png' %}"
					data-play="{% static 'img/Play.png' %}"
					data-pause="{% static 'img/Pause.png' %}"
					alt="Play"
				/>
			</div>

			<div class="audio" id="waveform">
				<!-- prettier-ignore -->
				<svg id="audioWave"
                        viewBox="0 0 864 154"
                        preserveAspectRatio="xMidYMid meet"
                        xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <mask id="progressMask">
                          <rect id="maskRect"
                                x="0"
                                y="0"
                                width="0"
                                height="154"
                                fill="white" />
                        </mask>
                      </defs>
                      <g id="baseWave" stroke="#b58f7a" stroke-width="5" stroke-linecap="round">

                        <line x1="28" y1="73.5" x2="28" y2="80.5"/>
                        <line x1="38" y1="72.0" x2="38" y2="82.0"/>
                        <line x1="48" y1="70.0" x2="48" y2="84.0"/>
                        <line x1="59" y1="68.5" x2="59" y2="85.5"/>
                        <line x1="69" y1="66.5" x2="69" y2="87.5"/>
                        <line x1="79" y1="68.5" x2="79" y2="85.5"/>
                        <line x1="89" y1="72.0" x2="89" y2="82.0"/>
                        <line x1="99" y1="65.5" x2="99" y2="88.5"/>
                        <line x1="110" y1="59.5" x2="110" y2="94.5"/>
                        <line x1="120" y1="61.5" x2="120" y2="92.5"/>
                        <line x1="130" y1="55.0" x2="130" y2="99.0"/>
                        <line x1="140" y1="57.5" x2="140" y2="96.5"/>
                        <line x1="150" y1="61.5" x2="150" y2="92.5"/>
                        <line x1="161" y1="65.0" x2="161" y2="89.0"/>
                        <line x1="171" y1="70.5" x2="171" y2="83.5"/>
                        <line x1="181" y1="73.5" x2="181" y2="80.5"/>
                        <line x1="191" y1="68.5" x2="191" y2="85.5"/>
                        <line x1="201" y1="58.5" x2="201" y2="95.5"/>
                        <line x1="212" y1="53.0" x2="212" y2="101.0"/>
                        <line x1="222" y1="38.0" x2="222" y2="116.0"/>
                        <line x1="232" y1="43.5" x2="232" y2="110.5"/>
                        <line x1="242" y1="48.5" x2="242" y2="105.5"/>
                        <line x1="253" y1="63.5" x2="253" y2="90.5"/>
                        <line x1="263" y1="70.5" x2="263" y2="83.5"/>
                        <line x1="273" y1="67.5" x2="273" y2="86.5"/>
                        <line x1="283" y1="58.5" x2="283" y2="95.5"/>
                        <line x1="293" y1="49.5" x2="293" y2="104.5"/>
                        <line x1="304" y1="42.0" x2="304" y2="112.0"/>
                        <line x1="314" y1="37.5" x2="314" y2="116.5"/>
                        <line x1="324" y1="31.5" x2="324" y2="122.5"/>
                        <line x1="334" y1="34.5" x2="334" y2="119.5"/>
                        <line x1="345" y1="42.0" x2="345" y2="112.0"/>
                        <line x1="355" y1="48.0" x2="355" y2="106.0"/>
                        <line x1="365" y1="46.5" x2="365" y2="107.5"/>
                        <line x1="375" y1="43.5" x2="375" y2="110.5"/>
                        <line x1="385" y1="39.0" x2="385" y2="115.0"/>
                        <line x1="396" y1="39.0" x2="396" y2="115.0"/>
                        <line x1="406" y1="51.5" x2="406" y2="102.5"/>
                        <line x1="416" y1="56.5" x2="416" y2="97.5"/>
                        <line x1="426" y1="47.5" x2="426" y2="106.5"/>
                        <line x1="436" y1="43.5" x2="436" y2="110.5"/>
                        <line x1="447" y1="28.0" x2="447" y2="126.0"/>
                        <line x1="457" y1="23.0" x2="457" y2="131.0"/>
                        <line x1="467" y1="35.5" x2="467" y2="118.5"/>
                        <line x1="477" y1="37.0" x2="477" y2="117.0"/>
                        <line x1="487" y1="42.0" x2="487" y2="112.0"/>
                        <line x1="498" y1="52.0" x2="498" y2="102.0"/>
                        <line x1="508" y1="46.5" x2="508" y2="107.5"/>
                        <line x1="518" y1="54.0" x2="518" y2="100.0"/>
                        <line x1="528" y1="59.0" x2="528" y2="95.0"/>
                        <line x1="539" y1="62.5" x2="539" y2="91.5"/>
                        <line x1="549" y1="67.0" x2="549" y2="87.0"/>
                        <line x1="559" y1="64.0" x2="559" y2="90.0"/>
                        <line x1="569" y1="61.5" x2="569" y2="92.5"/>
                        <line x1="579" y1="59.0" x2="579" y2="95.0"/>
                        <line x1="590" y1="63.5" x2="590" y2="90.5"/>
                        <line x1="600" y1="67.5" x2="600" y2="86.5"/>
                        <line x1="610" y1="71.5" x2="610" y2="82.5"/>
                        <line x1="620" y1="73.5" x2="620" y2="80.5"/>
                        <line x1="630" y1="73.5" x2="630" y2="80.5"/>
                        <line x1="641" y1="71.5" x2="641" y2="82.5"/>
                        <line x1="651" y1="66.5" x2="651" y2="87.5"/>
                        <line x1="661" y1="60.0" x2="661" y2="94.0"/>
                        <line x1="671" y1="47.5" x2="671" y2="106.5"/>
                        <line x1="682" y1="44.5" x2="682" y2="109.5"/>
                        <line x1="692" y1="52.0" x2="692" y2="102.0"/>
                        <line x1="702" y1="47.5" x2="702" y2="106.5"/>
                        <line x1="712" y1="45.5" x2="712" y2="108.5"/>
                        <line x1="722" y1="49.5" x2="722" y2="104.5"/>
                        <line x1="733" y1="55.0" x2="733" y2="99.0"/>
                        <line x1="743" y1="53.0" x2="743" y2="101.0"/>
                        <line x1="753" y1="57.5" x2="753" y2="96.5"/>
                        <line x1="763" y1="63.5" x2="763" y2="90.5"/>
                        <line x1="773" y1="67.5" x2="773" y2="86.5"/>
                        <line x1="784" y1="73.0" x2="784" y2="81.0"/>
                        <line x1="794" y1="69.5" x2="794" y2="84.5"/>
                        <line x1="804" y1="64.5" x2="804" y2="89.5"/>
                        <line x1="814" y1="68.5" x2="814" y2="85.5"/>
                        <line x1="825" y1="71.0" x2="825" y2="83.0"/>
                        <line x1="835" y1="73.5" x2="835" y2="80.5"/>

                      </g>
                      <g id="filledWave"
                        stroke="#802650"
                        stroke-width="5"
                        stroke-linecap="round"
                        mask="url(#progressMask)">
                        <line x1="28" y1="73.5" x2="28" y2="80.5"/>
                        <line x1="38" y1="72.0" x2="38" y2="82.0"/>
                        <line x1="48" y1="70.0" x2="48" y2="84.0"/>
                        <line x1="59" y1="68.5" x2="59" y2="85.5"/>
                        <line x1="69" y1="66.5" x2="69" y2="87.5"/>
                        <line x1="79" y1="68.5" x2="79" y2="85.5"/>
                        <line x1="89" y1="72.0" x2="89" y2="82.0"/>
                        <line x1="99" y1="65.5" x2="99" y2="88.5"/>
                        <line x1="110" y1="59.5" x2="110" y2="94.5"/>
                        <line x1="120" y1="61.5" x2="120" y2="92.5"/>
                        <line x1="130" y1="55.0" x2="130" y2="99.0"/>
                        <line x1="140" y1="57.5" x2="140" y2="96.5"/>
                        <line x1="150" y1="61.5" x2="150" y2="92.5"/>
                        <line x1="161" y1="65.0" x2="161" y2="89.0"/>
                        <line x1="171" y1="70.5" x2="171" y2="83.5"/>
                        <line x1="181" y1="73.5" x2="181" y2="80.5"/>
                        <line x1="191" y1="68.5" x2="191" y2="85.5"/>
                        <line x1="201" y1="58.5" x2="201" y2="95.5"/>
                        <line x1="212" y1="53.0" x2="212" y2="101.0"/>
                        <line x1="222" y1="38.0" x2="222" y2="116.0"/>
                        <line x1="232" y1="43.5" x2="232" y2="110.5"/>
                        <line x1="242" y1="48.5" x2="242" y2="105.5"/>
                        <line x1="253" y1="63.5" x2="253" y2="90.5"/>
                        <line x1="263" y1="70.5" x2="263" y2="83.5"/>
                        <line x1="273" y1="67.5" x2="273" y2="86.5"/>
                        <line x1="283" y1="58.5" x2="283" y2="95.5"/>
                        <line x1="293" y1="49.5" x2="293" y2="104.5"/>
                        <line x1="304" y1="42.0" x2="304" y2="112.0"/>
                        <line x1="314" y1="37.5" x2="314" y2="116.5"/>
                        <line x1="324" y1="31.5" x2="324" y2="122.5"/>
                        <line x1="334" y1="34.5" x2="334" y2="119.5"/>
                        <line x1="345" y1="42.0" x2="345" y2="112.0"/>
                        <line x1="355" y1="48.0" x2="355" y2="106.0"/>
                        <line x1="365" y1="46.5" x2="365" y2="107.5"/>
                        <line x1="375" y1="43.5" x2="375" y2="110.5"/>
                        <line x1="385" y1="39.0" x2="385" y2="115.0"/>
                        <line x1="396" y1="39.0" x2="396" y2="115.0"/>
                        <line x1="406" y1="51.5" x2="406" y2="102.5"/>
                        <line x1="416" y1="56.5" x2="416" y2="97.5"/>
                        <line x1="426" y1="47.5" x2="426" y2="106.5"/>
                        <line x1="436" y1="43.5" x2="436" y2="110.5"/>
                        <line x1="447" y1="28.0" x2="447" y2="126.0"/>
                        <line x1="457" y1="23.0" x2="457" y2="131.0"/>
                        <line x1="467" y1="35.5" x2="467" y2="118.5"/>
                        <line x1="477" y1="37.0" x2="477" y2="117.0"/>
                        <line x1="487" y1="42.0" x2="487" y2="112.0"/>
                        <line x1="498" y1="52.0" x2="498" y2="102.0"/>
                        <line x1="508" y1="46.5" x2="508" y2="107.5"/>
                        <line x1="518" y1="54.0" x2="518" y2="100.0"/>
                        <line x1="528" y1="59.0" x2="528" y2="95.0"/>
                        <line x1="539" y1="62.5" x2="539" y2="91.5"/>
                        <line x1="549" y1="67.0" x2="549" y2="87.0"/>
                        <line x1="559" y1="64.0" x2="559" y2="90.0"/>
                        <line x1="569" y1="61.5" x2="569" y2="92.5"/>
                        <line x1="579" y1="59.0" x2="579" y2="95.0"/>
                        <line x1="590" y1="63.5" x2="590" y2="90.5"/>
                        <line x1="600" y1="67.5" x2="600" y2="86.5"/>
                        <line x1="610" y1="71.5" x2="610" y2="82.5"/>
                        <line x1="620" y1="73.5" x2="620" y2="80.5"/>
                        <line x1="630" y1="73.5" x2="630" y2="80.5"/>
                        <line x1="641" y1="71.5" x2="641" y2="82.5"/>
                        <line x1="651" y1="66.5" x2="651" y2="87.5"/>
                        <line x1="661" y1="60.0" x2="661" y2="94.0"/>
                        <line x1="671" y1="47.5" x2="671" y2="106.5"/>
                        <line x1="682" y1="44.5" x2="682" y2="109.5"/>
                        <line x1="692" y1="52.0" x2="692" y2="102.0"/>
                        <line x1="702" y1="47.5" x2="702" y2="106.5"/>
                        <line x1="712" y1="45.5" x2="712" y2="108.5"/>
                        <line x1="722" y1="49.5" x2="722" y2="104.5"/>
                        <line x1="733" y1="55.0" x2="733" y2="99.0"/>
                        <line x1="743" y1="53.0" x2="743" y2="101.0"/>
                        <line x1="753" y1="57.5" x2="753" y2="96.5"/>
                        <line x1="763" y1="63.5" x2="763" y2="90.5"/>
                        <line x1="773" y1="67.5" x2="773" y2="86.5"/>
                        <line x1="784" y1="73.0" x2="784" y2="81.0"/>
                        <line x1="794" y1="69.5" x2="794" y2="84.5"/>
                        <line x1="804" y1="64.5" x2="804" y2="89.5"/>
                        <line x1="814" y1="68.5" x2="814" y2="85.5"/>
                        <line x1="825" y1="71.0" x2="825" y2="83.0"/>
                        <line x1="835" y1="73.5" x2="835" y2="80.5"/>
                        </g>
                    </svg>
			</div>
			<audio id="audioPlayer"></audio>
		</div>
	</div>
</div>

<div class="urbanlegendgirl-ani hide-on-mobile">
	<video autoplay muted loop playsinline>
		<source src="{% static 'video/urbangirl.webm' %}" type="video/mp4"  />
	</video>
</div>

<!-- âœ… JAVASCRIPT -->
<script>
	let storyItems;
	let updateStory;
</script>

<script>
	let storyTL;

	function playStoryAnimation() {
		// Kill previous animation if it exists
		if (storyTL) storyTL.kill();

		storyTL = gsap.timeline({
			defaults: { ease: 'power3.out' },
		});

		// ðŸ‘‰ ALL START AT THE SAME TIME (position: 0)
		storyTL
			.fromTo(
				'.story_name-inner',
				{ yPercent: 100, opacity: 0 },
				{ yPercent: 0, opacity: 1, duration: 0.6 },
				0,
			)
			.fromTo(
				'.story_text',
				{ y: 40, opacity: 0 },
				{ y: 0, opacity: 1, duration: 0.6 },
				0,
			)
			.fromTo(
				'.urbanlegend-img',
				{ scale: 0.96, opacity: 0 },
				{ scale: 1, opacity: 1, duration: 0.6 },
				0,
			)
			.fromTo(
				'.story-sound',
				{ opacity: 0, y: 20 },
				{ opacity: 1, y: 0, duration: 0.6 },
				0,
			);
	}
</script>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const master = gsap.timeline({
			defaults: { ease: 'power3.out' },
		});

		/* STEP 1 â€” TEXT SLIDE UP */
		master.fromTo(
			'.inner2',
			{ yPercent: 100, opacity: 0 },
			{ yPercent: 0, opacity: 1, duration: 0.6 },
		);

		/* STEP 2 â€” BOX FADE INS */
		master
			.fromTo(
				'.urbanlegendsbox1_1',
				{ opacity: 0 },
				{ opacity: 1, duration: 0.6 },
				'-=0.3',
			)
			.fromTo(
				'.urbanlegendsbox1_3',
				{ opacity: 0 },
				{ opacity: 1, duration: 0.6 },
				'<',
			);

		/* STEP 3 â€” BUTTON CIRCLE REVEAL */
		gsap.utils.toArray('.btn-fill-circle2').forEach((btn, i) => {
			master.fromTo(
				btn,
				{
					opacity: 0,
					y: 20,
				},
				{
					opacity: 1,
					y: 0,
					duration: 0.6,
					ease: 'power2.out',
				},
				i === 0 ? '+=0.2' : '<+=0.15',
			);
		});

		/* STORY CONTENT (LOCKED UNTIL GSAP ENDS) */
		master.fromTo(
			'.story_name-inner',
			{ yPercent: 100, opacity: 0 },
			{ yPercent: 0, opacity: 1, duration: 0.6, immediateRender: false },
			'<-=0.55',
		);

		master.fromTo(
			'.story_text',
			{ opacity: 0, y: 50 },
			{ opacity: 1, y: 0, duration: 0.6, immediateRender: false },
			'<+=0.15',
		);

		master.fromTo(
			'.urbanlegend-img',
			{ opacity: 0 },
			{ opacity: 1, duration: 0.45, immediateRender: false },
			'<+=0.15',
		);

		master.fromTo(
			'.urbanlegendsbird-ani',
			{ opacity: 0 },
			{ opacity: 1, duration: 0.45 },
			'<+=0.15',
		);

		master.fromTo(
			'.story-sound',
			{ opacity: 0 },
			{ opacity: 1, duration: 0.45, immediateRender: false },
			'<',
		);

		/* âœ… WAIT UNTIL STORIES ARE READY, THEN LOAD FIRST STORY */
		document.addEventListener(
			'storiesReady',
			() => {
				master.eventCallback('onComplete', () => {
					updateStory(storyItems[0]);
				});
			},
			{ once: true },
		);
	});
</script>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		storyItems = document.querySelectorAll('.story');
		const titleEl = document.querySelector('.story_name-inner');
		const textEl = document.getElementById('storyText');
		const imageEl = document.getElementById('storyImage');
		const audioBox = document.getElementById('storyAudioBox');
		const playBtn = document.getElementById('playPauseBtn');

		/* ===============================
       UPDATE STORY FUNCTION
    =============================== */
		updateStory = function (storyDiv) {
			// ðŸ”“ REVEAL TEXT CONTAINER NOW (CONTENT EXISTS)
			const textWrapper = document.querySelector('.urbanlegend-text');
			textWrapper.style.visibility = 'visible';
			textWrapper.style.opacity = '1';

			const title = storyDiv.dataset.title;
			const text = storyDiv.dataset.text;
			const image = storyDiv.dataset.image;
			const audio = storyDiv.dataset.audio;

			titleEl.textContent = title;
			textEl.textContent = text;
			textEl.scrollTop = 0;

			if (image) {
				imageEl.src = image;
				imageEl.onload = () => {
					imageEl.closest('.urbanlegend-img').style.display = 'block';
				};
			} else {
				imageEl.closest('.urbanlegend-img').style.display = 'none';
			}

			if (audio) {
				audioBox.style.display = 'flex';

				audioPlayer.pause();
				audioPlayer.currentTime = 0;
				audioPlayer.src = audio;
				audioPlayer.load();

				maskRect.setAttribute('width', 0);
				playBtn.src = playBtn.dataset.play;
			} else {
				audioBox.style.display = 'none';
			}

			// âœ… ALWAYS RUN THESE
			storyItems.forEach((i) => i.classList.remove('active'));
			storyDiv.classList.add('active');

			if (typeof playStoryAnimation === 'function') {
				playStoryAnimation();
			}
		};

		/* ===============================
       CLICK HANDLERS
    =============================== */
		storyItems.forEach((item) => {
			item.addEventListener('click', () => updateStory(item));
		});

		// ðŸ”” signal GSAP
		document.dispatchEvent(new Event('storiesReady'));
	});
</script>

<script>
	const audioPlayer = document.getElementById('audioPlayer');
	const maskRect = document.getElementById('maskRect');

	// ðŸ”‘ GLOBAL STATE (per page)
	let wasPlayingBeforeMute = false;
	let rafId = null;

	function initAudioPlayer() {
		const playBtn = document.getElementById('playPauseBtn');
		const svg = document.getElementById('audioWave');

		if (!audioPlayer || !playBtn || !maskRect || !svg) return;

		function stopRAF() {
			if (rafId) {
				cancelAnimationFrame(rafId);
				rafId = null;
			}
		}

		function updateMaskSmooth() {
			if (audioPlayer.ended || audioPlayer.paused || !audioPlayer.duration) return;

			const progress = audioPlayer.currentTime / audioPlayer.duration;

			const WAVE_START = 25;
			const WAVE_WIDTH = 807;

			maskRect.setAttribute('x', WAVE_START);
			maskRect.setAttribute('width', WAVE_WIDTH * progress);

			rafId = requestAnimationFrame(updateMaskSmooth);
		}

		/* ---------- PLAY / PAUSE BUTTON ---------- */
		playBtn.addEventListener('click', () => {
			stopRAF();

			// âŒ Respect global mute
			if (localStorage.getItem('kioskMuted') === 'true') return;

			if (audioPlayer.paused) {
				audioPlayer.play().then(() => {
					playBtn.src = playBtn.dataset.pause;
					updateMaskSmooth();
				});
			} else {
				audioPlayer.pause();
				playBtn.src = playBtn.dataset.play;
			}
		});

		/* ---------- AUDIO EVENTS ---------- */
		audioPlayer.addEventListener('ended', () => {
			stopRAF();
			maskRect.setAttribute('width', 0);
			playBtn.src = playBtn.dataset.play;
		});

		audioPlayer.addEventListener('loadedmetadata', () => {
			stopRAF();
			maskRect.setAttribute('width', 0);
		});

		audioPlayer.addEventListener('pause', stopRAF);
		audioPlayer.addEventListener('play', updateMaskSmooth);
	}

	/* =====================================================
	   GLOBAL AUDIO TOGGLE HANDLER (THE KEY FIX)
	===================================================== */
	document.addEventListener('globalAudioToggle', (e) => {
		if (!audioPlayer) return;

		if (e.detail.muted) {
			// ðŸ”‡ Audio OFF
			wasPlayingBeforeMute = !audioPlayer.paused;
			audioPlayer.pause();
		} else {
			// ðŸ”Š Audio ON
			if (wasPlayingBeforeMute) {
				audioPlayer.play().then(() => {
					updateMaskAfterResume();
				}).catch(() => {});
			}
		}
	});

	function updateMaskAfterResume() {
		cancelAnimationFrame(rafId);
		rafId = requestAnimationFrame(function tick() {
			if (audioPlayer.paused || !audioPlayer.duration) return;
			const progress = audioPlayer.currentTime / audioPlayer.duration;
			maskRect.setAttribute('width', 807 * progress);
			rafId = requestAnimationFrame(tick);
		});
	}

	document.addEventListener('DOMContentLoaded', initAudioPlayer);
</script>


{% endblock %}
